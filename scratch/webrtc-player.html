<meta charset="UTF-8">
<html>

<head>
	<script src="webrtc-player.js"></script>
	<style>
		.div-section {
			margin-bottom: 8px;
		}
	</style>
</head>

<body>
	<div class="div-section">
		<table>
			<tr>
				<td>Stream:</td>
				<td>
					<select id="streamSelect" onchange="changeStream()"></select>
				</td>
				<td>
					<button onclick="refreshStreamList()">Refresh list</button>
				</td>
			</tr>
		</table>
	</div>
	<div class="div-section">
		<video id="remoteVideo" autoplay playsinline controls style="height:480px;"></video>
	</div>

	<script type="text/javascript">
		const connectionClient = new ConnectionClient({ host: `http://${window.location.hostname}:3002` });
		let peerConnection = null;
		async function startStream(streamId) {
			if (peerConnection) {
				stopStream()
			}

			if (streamId === undefined) {
				const list = await connectionClient.listStreams()
				if (!list || list.length === 0) throw new Error('No streams')
				streamId = list[0].streamId
			}
			peerConnection = await connectionClient.createConnection(streamId, { beforeAnswer });
		}
		function stopStream() {
			peerConnection.close()
			peerConnection = null
		}

		async function beforeAnswer(peerConnection) {
			const videoElm = document.getElementById('remoteVideo');

			const remoteStream = new MediaStream(peerConnection.getReceivers().map(receiver => receiver.track));
			videoElm.srcObject = remoteStream;

			console.log('configured video element')

			// NOTE(mroberts): This is a hack so that we can get a callback when the
			// RTCPeerConnection is closed. In the future, we can subscribe to
			// "connectionstatechange" events.
			const { close } = peerConnection;
			peerConnection.close = function () {
				videoElm.srcObject = null;

				return close.apply(this, arguments);
			};
		}

		async function refreshStreamList() {
			const list = await connectionClient.listStreams()

			const listElm = document.querySelector('#streamSelect')
			listElm.innerHTML = ''

			for (const s of list) {
				const e = document.createElement('option')
				e.innerText = s.description
				e.setAttribute('id', s.streamId)
				listElm.appendChild(e)
			}
		}

		async function changeStream(e) {
			const streamId = document.querySelector('#streamSelect option:checked').id
			console.log('changing to', streamId)
			if (streamId) {
				startStream(streamId)
			}
		}

		refreshStreamList();
		startStream();

	</script>
</body>

</html>